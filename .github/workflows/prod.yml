name: Deploy MicrosserviÃ§os Calculos

on:
    push:
        branches: [develop]

jobs:
    build:
        runs-on: ubuntu-22.04
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setupe Java
              uses: actions/setup-java@v3
              with:
                distribution: 'temurin'
                java-version: '17'

            - name: Acessando sub projeto Api-Rest e Fazendo Build
              run: cd api-rest && mvn clean install -DskipTests

            - name: Acessando sub projeto Calculo-Processor e Gerando Build
              run: cd calculo-processor && mvn clean install -DskipTests

            - name: Setup SSH Key and SSH Agent
              run: |
                mkdir -p ~/.ssh
                echo "${{ secrets.SSH_KEY_LOCAL }}" > ~/.ssh/id_rsa
                chmod 600 ~/.ssh/id_rsa
                eval "$(ssh-agent -s)"
                ssh-add ~/.ssh/id_rsa
                ssh-keyscan -H 195.200.6.22 >> ~/.ssh/known_hosts

            - name: Remover Jar Files
              uses: appleboy/ssh-action@master
              with:
                host: ${{ secrets.VPS_HOST }}
                username: ${{ secrets.VPS_USERNAME }}
                password: ${{ secrets.VPS_PASSWORD }}
                script: |
                     rm ../sistema/calculos-0.0.1-SNAPSHOT.jar || true
                     rm ../sistema/processor-0.0.1-SNAPSHOT.jar || true

            - name: Enviando JARs para a VPS
              run: |
                 scp -o StrictHostKeyChecking=no -P 22 api-rest/target/calculos-0.0.1-SNAPSHOT.jar ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/sistema/
                 scp -o StrictHostKeyChecking=no -P 22 calculo-processor/target/processor-0.0.1-SNAPSHOT.jar ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/sistema/                 
              env:
                SSH_KEY: ${{ secrets.SSH_KEY_LOCAL }}
